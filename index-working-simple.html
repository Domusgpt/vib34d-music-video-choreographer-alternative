<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D Music Video Choreographer - Dual Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #000;
            color: #0ff;
            overflow: hidden;
        }

        #visualizer-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .holographic-layers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .holographic-layers canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #mode-selector {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #0ff;
            border-radius: 15px;
            padding: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 400px;
        }

        #mode-selector h2 {
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #0ff, #f0f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
        }

        .mode-btn {
            flex: 1;
            background: linear-gradient(135deg, #0a4d68, #0ff);
            border: none;
            color: #000;
            padding: 20px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px #0ff;
        }

        .mode-btn .emoji {
            font-size: 32px;
        }

        .mode-btn .subtitle {
            font-size: 10px;
            opacity: 0.8;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0ff;
            border-radius: 15px;
            padding: 20px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 15px;
            min-width: 600px;
            transition: all 0.3s ease;
        }

        #controls.active {
            display: flex;
        }

        #controls.collapsed {
            min-height: auto;
        }

        #controls.collapsed .control-content {
            display: none;
        }

        .collapse-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #0ff;
            color: #0ff;
            padding: 5px 10px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .collapse-toggle:hover {
            background: rgba(0, 255, 255, 0.4);
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: linear-gradient(135deg, #0a4d68, #0ff);
            border: none;
            color: #000;
            padding: 12px 24px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #0ff;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-input-label {
            background: linear-gradient(135deg, #4a0a68, #f0f);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            text-transform: uppercase;
        }

        .file-input-label:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #f0f;
        }

        input[type="file"] {
            display: none;
        }

        #timeline {
            width: 100%;
            height: 8px;
            background: #111;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        #timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0f);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }

        #status {
            text-align: center;
            font-size: 12px;
            color: #0ff;
        }

        .system-selector {
            display: flex;
            gap: 10px;
        }

        .system-btn {
            flex: 1;
            padding: 10px;
            font-size: 12px;
        }

        .system-btn.active {
            background: linear-gradient(135deg, #0ff, #00ff88);
            box-shadow: 0 0 15px #0ff;
        }

        #info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 15px;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }

        #info-panel.active {
            display: block;
        }

        #info-panel h3 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #0ff;
        }

        #info-panel p {
            font-size: 11px;
            line-height: 1.5;
            color: #aaa;
            margin-bottom: 8px;
        }

        .beat-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 3px solid #0ff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.1s;
            pointer-events: none;
            z-index: 999;
        }

        .beat-indicator.active {
            opacity: 0.8;
            animation: beatPulse 0.3s ease-out;
        }

        @keyframes beatPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Timeline Editor Mode */
        #timeline-editor {
            position: fixed;
            left: 20px;
            top: 120px;
            bottom: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #f0f;
            border-radius: 10px;
            padding: 15px;
            z-index: 1500;
            display: none;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        #timeline-editor.active {
            display: flex;
        }

        #timeline-editor.collapsed {
            width: 60px;
            overflow: hidden;
        }

        #timeline-editor.collapsed .timeline-content {
            display: none;
        }

        #timeline-editor.collapsed h3 {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin: 0;
            padding: 10px 0;
        }

        #timeline-editor h3 {
            color: #f0f;
            margin-bottom: 10px;
        }

        .sequence-item {
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid #f0f;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .sequence-item h4 {
            color: #f0f;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .sequence-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 10px;
        }

        .sequence-controls label {
            color: #aaa;
        }

        .sequence-controls input,
        .sequence-controls select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #0ff;
            padding: 5px;
            border-radius: 3px;
            font-family: 'Orbitron', monospace;
            font-size: 10px;
        }

        .add-sequence-btn {
            background: linear-gradient(135deg, #4a0a68, #f0f);
            margin-top: 10px;
        }

        .mode-toggle {
            background: linear-gradient(135deg, #68520a, #ff0);
            color: #000;
        }

        @media (max-width: 768px) {
            #mode-selector {
                min-width: 90%;
                max-width: 90%;
                padding: 15px;
                top: 10px;
            }

            #mode-selector h2 {
                font-size: 16px;
            }

            .mode-buttons {
                flex-direction: column;
            }

            .mode-btn {
                padding: 15px;
                font-size: 12px;
            }

            .mode-btn .emoji {
                font-size: 24px;
            }

            #controls {
                min-width: 90%;
                max-width: 90%;
                bottom: 10px;
                padding: 15px 10px;
            }

            .control-row {
                flex-wrap: wrap;
            }

            .control-row button,
            .file-input-label {
                flex: 1 1 45%;
                font-size: 11px;
                padding: 8px 12px;
            }

            .system-btn {
                font-size: 10px;
                padding: 8px;
            }

            #timeline-editor {
                width: 90%;
                max-width: 90%;
                left: 5%;
                top: 80px;
                bottom: auto;
                max-height: 60vh;
            }

            #timeline-editor h3 {
                font-size: 14px;
            }

            .sequence-item {
                padding: 8px;
                font-size: 10px;
            }

            .sequence-item h4 {
                font-size: 11px;
            }

            .collapse-toggle {
                font-size: 14px;
                padding: 3px 8px;
            }

            #info-panel {
                max-width: 90%;
                right: 5%;
                top: 10px;
                font-size: 10px;
                padding: 10px;
            }

            #info-panel h3 {
                font-size: 12px;
            }

            #info-panel p {
                font-size: 9px;
            }

            #status {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Mode Selection Screen -->
    <div id="mode-selector">
        <h2>üéµ VIB34D MUSIC VIDEO CHOREOGRAPHER</h2>
        <p style="text-align: center; font-size: 11px; color: #aaa; margin-bottom: 10px;">
            Choose your mode: Let AI choreograph, or design your own sequences
        </p>
        <div class="mode-buttons">
            <button class="mode-btn" onclick="selectMode('reactive')">
                <span class="emoji">üéß</span>
                <span>REACTIVE MODE</span>
                <span class="subtitle">Real-time audio reactivity<br>Let the system respond to music</span>
            </button>
            <button class="mode-btn" onclick="selectMode('choreographed')">
                <span class="emoji">üé¨</span>
                <span>HYBRID MODE</span>
                <span class="subtitle">Choreographed sequences<br>+ Audio reactivity + System switching</span>
            </button>
        </div>
    </div>

    <div id="visualizer-container">
        <div class="holographic-layers" id="vib34dLayers"></div>
        <div class="holographic-layers" id="quantumLayers" style="display: none;"></div>
        <div class="holographic-layers" id="holographicLayers" style="display: none;"></div>
    </div>

    <div class="beat-indicator" id="beatIndicator"></div>

    <div id="info-panel">
        <h3 id="mode-title">üéß REACTIVE MODE</h3>
        <p id="mode-description">Real-time audio analysis with automatic parameter mapping</p>
        <p id="beat-info">BPM: -- | Beat: --</p>
        <p id="energy-info">Energy: -- | Bass: --</p>
    </div>

    <!-- Timeline Editor for Choreography Mode -->
    <div id="timeline-editor">
        <button class="collapse-toggle" onclick="toggleTimeline()">‚óÄ</button>
        <h3>üìù Sequence Timeline</h3>
        <div class="timeline-content">
            <button class="add-sequence-btn" onclick="addSequence()">+ Add Sequence</button>
            <div id="sequence-list"></div>
            <button onclick="saveChoreography()">üíæ Save Choreography</button>
            <button onclick="loadChoreography()">üìÇ Load Choreography</button>
        </div>
    </div>

    <div id="controls">
        <button class="collapse-toggle" onclick="toggleControls()">‚ñº</button>
        <div class="control-content">
            <div class="control-row">
                <label for="audio-file" class="file-input-label">
                    üìÅ Load Audio File
                </label>
                <input type="file" id="audio-file" accept="audio/*">
                <button id="play-btn" disabled>‚ñ∂ Play</button>
                <button id="pause-btn" disabled>‚è∏ Pause</button>
                <button id="stop-btn" disabled>‚èπ Stop</button>
                <button class="mode-toggle" onclick="toggleMode()">üîÑ Switch Mode</button>
            </div>

            <div id="timeline">
                <div id="timeline-progress"></div>
            </div>

            <div class="system-selector">
                <button class="system-btn active" data-system="faceted">üî∑ FACETED</button>
                <button class="system-btn" data-system="quantum">üåå QUANTUM</button>
                <button class="system-btn" data-system="holographic">‚ú® HOLOGRAPHIC</button>
            </div>

            <div class="control-row">
                <button onclick="exportVideo()">üé• Export Video</button>
            </div>

            <div id="status">Select a mode to begin</div>
        </div>
    </div>

    <script type="module">
        import { VIB34DIntegratedEngine } from './src/core/Engine.js';
        import { QuantumEngine } from './src/quantum/QuantumEngine.js';
        import { RealHolographicSystem } from './src/holograms/RealHolographicSystem.js';
        import { CanvasManager } from './src/core/CanvasManager.js';

        let canvasManager = null;
        let currentMode = null;
        let currentEngine = null;
        let currentSystem = 'faceted';

        // Audio system
        let audioElement = null;
        let audioContext = null;
        let analyser = null;
        let sourceNode = null;
        let dataArray = null;
        let isPlaying = false;
        let animationId = null;

        // Engine classes for CanvasManager
        const engineClasses = {
            VIB34DIntegratedEngine,
            QuantumEngine,
            RealHolographicSystem
        };

        // Beat detection
        let beatThreshold = 0.7;
        let lastBeatTime = 0;
        let detectedBPM = 0;

        // Choreography sequences
        let sequences = [];

        window.selectMode = async function(mode) {
            currentMode = mode;
            document.getElementById('mode-selector').style.display = 'none';
            document.getElementById('controls').classList.add('active');
            document.getElementById('info-panel').classList.add('active');

            if (mode === 'choreographed') {
                document.getElementById('timeline-editor').classList.add('active');
                document.getElementById('mode-title').textContent = 'üé¨ HYBRID MODE';
                document.getElementById('mode-description').textContent = 'Choreographed sequences + Full audio reactivity + System switching';
                await generateDefaultChoreography();
            } else {
                document.getElementById('mode-title').textContent = 'üéß REACTIVE MODE';
                document.getElementById('mode-description').textContent = 'Real-time audio analysis with automatic parameter mapping';
            }

            // Initialize CanvasManager
            canvasManager = new CanvasManager();

            // Initialize audio system
            audioElement = new Audio();
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Setup event listeners
            setupEventListeners();

            // Initialize faceted system
            await switchSystem('faceted');

            console.log(`‚úÖ ${mode.toUpperCase()} mode initialized`);
        };

        function setupEventListeners() {
            // File input
            document.getElementById('audio-file').addEventListener('change', (e) => {
                loadAudioFile(e.target.files[0]);
            });

            // Playback controls
            document.getElementById('play-btn').addEventListener('click', () => play());
            document.getElementById('pause-btn').addEventListener('click', () => pause());
            document.getElementById('stop-btn').addEventListener('click', () => stop());

            // Timeline seeking
            document.getElementById('timeline').addEventListener('click', (e) => {
                if (!audioElement.src) return;
                const rect = e.target.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                audioElement.currentTime = pos * audioElement.duration;
            });

            // System switching
            document.querySelectorAll('.system-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchSystem(btn.dataset.system);
                });
            });

            // Audio events
            audioElement.addEventListener('ended', () => stop());
            audioElement.addEventListener('timeupdate', () => updateTimeline());
        }

        async function loadAudioFile(file) {
            if (!file) return;

            const url = URL.createObjectURL(file);
            audioElement.src = url;

            // Connect audio to analyser
            if (!sourceNode) {
                sourceNode = audioContext.createMediaElementSource(audioElement);
                sourceNode.connect(analyser);
                analyser.connect(audioContext.destination);
            }

            // Enable controls
            document.getElementById('play-btn').disabled = false;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('stop-btn').disabled = false;

            document.getElementById('status').textContent = `Loaded: ${file.name}`;
            console.log('üéµ Audio file loaded:', file.name);
        }

        async function switchSystem(systemName) {
            console.log(`üîÑ Switching to ${systemName}`);

            // Use CanvasManager to switch
            currentEngine = await canvasManager.switchToSystem(systemName, engineClasses);
            currentSystem = systemName;

            // Update UI
            document.querySelectorAll('.system-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.system === systemName);
            });

            console.log(`‚úÖ Switched to ${systemName}`);
        }

        function play() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            audioElement.play();
            isPlaying = true;
            startVisualization();
            document.getElementById('status').textContent = 'Playing...';
        }

        function pause() {
            audioElement.pause();
            isPlaying = false;
            document.getElementById('status').textContent = 'Paused';
        }

        function stop() {
            audioElement.pause();
            audioElement.currentTime = 0;
            isPlaying = false;
            document.getElementById('status').textContent = 'Stopped';
        }

        function startVisualization() {
            const render = () => {
                if (!isPlaying) return;

                // Get audio data
                analyser.getByteFrequencyData(dataArray);
                const audioData = processAudioData(dataArray);

                // Detect beats
                detectBeat(audioData);

                // Apply mode-specific logic
                if (currentMode === 'reactive') {
                    applyReactiveMode(audioData);
                } else if (currentMode === 'choreographed') {
                    applyChoreography(audioData);
                }

                // Update info panel
                updateInfoPanel(audioData);

                animationId = requestAnimationFrame(render);
            };
            render();
        }

        function processAudioData(dataArray) {
            const bass = getAverage(dataArray, 0, 100) / 255;
            const mid = getAverage(dataArray, 100, 400) / 255;
            const high = getAverage(dataArray, 400, 1024) / 255;
            const energy = (bass + mid + high) / 3;

            return { bass, mid, high, energy };
        }

        function getAverage(array, start, end) {
            let sum = 0;
            for (let i = start; i < end; i++) {
                sum += array[i];
            }
            return sum / (end - start);
        }

        function detectBeat(audioData) {
            const now = Date.now();
            if (audioData.bass > beatThreshold && now - lastBeatTime > 500) {
                lastBeatTime = now;
                onBeat();
                detectedBPM = Math.round(60000 / 500);
            }
        }

        function onBeat() {
            const indicator = document.getElementById('beatIndicator');
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 300);

            if (currentEngine && currentEngine.triggerClick) {
                currentEngine.triggerClick(1.0);
            }
        }

        function applyReactiveMode(audioData) {
            const setParam = (param, value) => {
                if (currentEngine.parameterManager) {
                    currentEngine.parameterManager.setParameter(param, value);
                } else if (currentEngine.updateParameter) {
                    currentEngine.updateParameter(param, value);
                } else if (currentEngine.updateParameters) {
                    currentEngine.updateParameters({ [param]: value });
                }
            };

            const densityBase = 15 + audioData.bass * 30;
            setParam('gridDensity', Math.floor(densityBase));

            const morphBase = 1.0 + audioData.mid * 0.5;
            setParam('morphFactor', morphBase);

            const chaosValue = 0.2 + audioData.high * 0.6;
            setParam('chaos', chaosValue);

            const speedValue = 1.0 + audioData.energy * 0.5;
            setParam('speed', speedValue);

            const intensityValue = 0.5 + audioData.energy * 0.5;
            setParam('intensity', intensityValue);

            const saturationValue = 0.7 + audioData.bass * 0.3;
            setParam('saturation', saturationValue);

            const currentTime = audioElement.currentTime;
            const hueShift = (audioData.mid * 60 + audioData.high * 30) % 360;
            setParam('hue', (currentTime * 5 + hueShift) % 360);

            setParam('rot4dXW', Math.sin(currentTime * 0.5 + audioData.bass * Math.PI) * Math.PI);
            setParam('rot4dYW', Math.cos(currentTime * 0.3 + audioData.mid * Math.PI) * Math.PI);
            setParam('rot4dZW', Math.sin(currentTime * 0.7 + audioData.high * Math.PI) * Math.PI);
        }

        async function applyChoreography(audioData) {
            const currentTime = audioElement.currentTime;

            const activeSequence = sequences.find(seq =>
                currentTime >= seq.time && currentTime < seq.time + seq.duration
            );

            if (!activeSequence) return;

            const effects = activeSequence.effects;

            // System switching
            if (effects.system && effects.system !== currentSystem) {
                console.log(`üé¨ Switching to ${effects.system} at ${currentTime.toFixed(1)}s`);
                await switchSystem(effects.system);
            }

            const setParam = (param, value) => {
                if (currentEngine.parameterManager) {
                    currentEngine.parameterManager.setParameter(param, value);
                } else if (currentEngine.updateParameter) {
                    currentEngine.updateParameter(param, value);
                } else if (currentEngine.updateParameters) {
                    currentEngine.updateParameters({ [param]: value });
                }
            };

            // Apply choreographed parameters with audio reactivity
            const chaosBase = effects.chaos || 0.5;
            setParam('chaos', chaosBase + audioData.energy * 0.4);

            const speedBase = effects.speed || 1.0;
            setParam('speed', speedBase * (1 + audioData.energy * 0.6));

            const densityBase = 15;
            setParam('gridDensity', Math.floor(densityBase + audioData.bass * 35));

            let hueValue = 0;
            if (effects.colorShift === 'rainbow') {
                hueValue = (currentTime * 60 + audioData.energy * 60) % 360;
            } else if (effects.colorShift === 'fast') {
                hueValue = (currentTime * 30 + audioData.bass * 120) % 360;
            } else if (effects.colorShift === 'medium') {
                hueValue = (currentTime * 10 + audioData.mid * 60) % 360;
            } else {
                hueValue = (currentTime * 5 + audioData.high * 30) % 360;
            }
            setParam('hue', hueValue % 360);

            setParam('intensity', 0.5 + audioData.energy * 0.5);
            setParam('saturation', 0.7 + audioData.bass * 0.3);
        }

        async function generateDefaultChoreography() {
            sequences = [
                { time: 0, duration: 15, effects: { system: 'faceted', chaos: 0.1, speed: 0.5, colorShift: 'slow' } },
                { time: 15, duration: 15, effects: { system: 'faceted', chaos: 0.3, speed: 1.0, colorShift: 'medium' } },
                { time: 30, duration: 20, effects: { system: 'quantum', chaos: 0.8, speed: 2.0, colorShift: 'fast' } },
                { time: 50, duration: 10, effects: { system: 'holographic', chaos: 0.9, speed: 2.5, colorShift: 'rainbow' } },
                { time: 60, duration: 15, effects: { system: 'faceted', chaos: 0.05, speed: 0.3, colorShift: 'slow' } },
                { time: 75, duration: 999, effects: { system: 'quantum', chaos: 1.0, speed: 3.0, colorShift: 'rainbow' } }
            ];
            renderSequenceList();
        }

        function renderSequenceList() {
            const list = document.getElementById('sequence-list');
            if (!list) return;

            list.innerHTML = sequences.map((seq, index) => `
                <div class="sequence-item">
                    <h4>Sequence ${index + 1} (${seq.time}s - ${seq.time + seq.duration}s)</h4>
                    <div class="sequence-controls">
                        <label>System</label>
                        <select onchange="window.updateSequence(${index}, 'system', this.value)" style="grid-column: span 2;">
                            <option value="faceted" ${seq.effects.system === 'faceted' ? 'selected' : ''}>üî∑ Faceted</option>
                            <option value="quantum" ${seq.effects.system === 'quantum' ? 'selected' : ''}>üåå Quantum</option>
                            <option value="holographic" ${seq.effects.system === 'holographic' ? 'selected' : ''}>‚ú® Holographic</option>
                        </select>
                    </div>
                </div>
            `).join('');
        }

        window.updateSequence = function(index, property, value) {
            if (sequences[index]) {
                sequences[index].effects[property] = value;
            }
        };

        function updateTimeline() {
            if (!audioElement.duration) return;
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            document.getElementById('timeline-progress').style.width = progress + '%';
        }

        function updateInfoPanel(audioData) {
            document.getElementById('beat-info').textContent = `BPM: ${detectedBPM} | Energy: ${(audioData.energy * 100).toFixed(0)}%`;
            document.getElementById('energy-info').textContent = `Bass: ${(audioData.bass * 100).toFixed(0)}% | Mid: ${(audioData.mid * 100).toFixed(0)}%`;
        }

        window.toggleMode = function() {
            const newMode = currentMode === 'reactive' ? 'choreographed' : 'reactive';
            selectMode(newMode);
        };

        window.toggleControls = function() {
            const controls = document.getElementById('controls');
            const toggle = controls.querySelector('.collapse-toggle');
            controls.classList.toggle('collapsed');
            toggle.textContent = controls.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
        };

        window.toggleTimeline = function() {
            const timeline = document.getElementById('timeline-editor');
            const toggle = timeline.querySelector('.collapse-toggle');
            timeline.classList.toggle('collapsed');
            toggle.textContent = timeline.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        };

        window.exportVideo = async function() {
            if (!audioElement || !audioElement.src) {
                alert('Please load an audio file first');
                return;
            }

            const status = document.getElementById('status');
            status.textContent = 'Preparing export...';

            document.getElementById('controls').style.display = 'none';
            document.getElementById('timeline-editor').style.display = 'none';
            document.getElementById('info-panel').style.display = 'none';

            try {
                const canvas = document.querySelector('canvas');
                if (!canvas) throw new Error('No canvas found');

                const stream = canvas.captureStream(60);

                const audioCtx = new AudioContext();
                const source = audioCtx.createMediaElementSource(audioElement);
                const dest = audioCtx.createMediaStreamDestination();
                source.connect(dest);
                source.connect(audioCtx.destination);

                stream.addTrack(dest.stream.getAudioTracks()[0]);

                const recorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 5000000
                });

                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);

                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vib34d-export-${Date.now()}.webm`;
                    a.click();

                    document.getElementById('controls').style.display = 'flex';
                    if (currentMode === 'choreographed') {
                        document.getElementById('timeline-editor').style.display = 'flex';
                    }
                    document.getElementById('info-panel').style.display = 'block';
                    status.textContent = 'Export complete!';
                };

                recorder.start();
                audioElement.currentTime = 0;
                await audioElement.play();

                status.textContent = 'Recording...';

                audioElement.onended = () => {
                    recorder.stop();
                    audioCtx.close();
                };

            } catch (error) {
                console.error('Export failed:', error);
                status.textContent = 'Export failed: ' + error.message;

                document.getElementById('controls').style.display = 'flex';
                if (currentMode === 'choreographed') {
                    document.getElementById('timeline-editor').style.display = 'flex';
                }
                document.getElementById('info-panel').style.display = 'block';
            }
        };

        window.addSequence = function() {
            const newSeq = {
                time: audioElement.currentTime || 0,
                duration: 10,
                effects: { system: currentSystem, chaos: 0.5, speed: 1.0, colorShift: 'medium' }
            };
            sequences.push(newSeq);
            sequences.sort((a, b) => a.time - b.time);
            renderSequenceList();
        };

        window.saveChoreography = function() {
            const data = JSON.stringify(sequences, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'choreography.json';
            a.click();
        };

        window.loadChoreography = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        sequences = JSON.parse(event.target.result);
                        renderSequenceList();
                    } catch (error) {
                        console.error('Failed to import:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };
    </script>
</body>
</html>